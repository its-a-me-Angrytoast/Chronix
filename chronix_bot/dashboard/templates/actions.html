{% extends "base.html" %}
{% block content %}
  <h1>Dashboard Actions</h1>
  <p class="lead">Audit trail of actions requested via the dashboard.</p>
  <div class="card">
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
      <label>Op</label>
      <input id="filter-op" placeholder="e.g. enable,disable,reload,hot_reload" />
      <label>Cog</label>
      <input id="filter-cog" placeholder="cog name" />
      <button id="apply-filters" class="btn">Filter</button>
      <button id="clear-filters" class="btn">Clear</button>
    </div>
    <div id="actions-list"></div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:12px">
      <button id="prev-page" class="btn">Prev</button>
      <span>Page <strong id="page-num">1</strong></span>
      <button id="next-page" class="btn">Next</button>
    </div>
  </div>

  <script>
    let PAGE = 1; const PER = 50;
    async function fetchActions(){
      const op = document.getElementById('filter-op').value || undefined;
      const cog = document.getElementById('filter-cog').value || undefined;
      const q = new URLSearchParams(); q.set('page', PAGE); q.set('per_page', PER); if(op) q.set('op',op); if(cog) q.set('cog',cog);
      const res = await fetch('/actions/list?'+q.toString());
      if(!res.ok) return document.getElementById('actions-list').innerHTML = '<p class="lead">Failed to load actions</p>';
      const j = await res.json(); const items = j.actions || [];
      const container = document.getElementById('actions-list'); container.innerHTML = '';
      if(items.length === 0) container.innerHTML = '<p class="lead">No actions</p>';
      items.forEach(a=>{
        const div = document.createElement('div'); div.className='note';
        const when = a.ts ? new Date((a.ts||0)*1000).toLocaleString() : '';
        div.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${a.op||''}</strong> ${a.cog?('('+a.cog+')'):''}</div><div>${when}</div></div><div style="margin-top:6px"><pre style="white-space:pre-wrap;margin:0">${JSON.stringify(a, null, 2)}</pre></div>`;
        container.appendChild(div);
      });
      document.getElementById('page-num').textContent = String(j.page || PAGE);
    }
    document.getElementById('apply-filters').addEventListener('click', ()=>{ PAGE=1; fetchActions(); });
    document.getElementById('clear-filters').addEventListener('click', ()=>{ document.getElementById('filter-op').value=''; document.getElementById('filter-cog').value=''; PAGE=1; fetchActions(); });
    document.getElementById('prev-page').addEventListener('click', ()=>{ if(PAGE>1){ PAGE--; fetchActions(); }});
    document.getElementById('next-page').addEventListener('click', ()=>{ PAGE++; fetchActions(); });
    document.addEventListener('DOMContentLoaded', ()=>{ fetchActions(); });
  </script>
{% endblock %}
