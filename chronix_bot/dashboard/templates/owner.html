{% extends "base.html" %}
{% block content %}
  <h1>Owner Panel</h1>
  <p class="lead">Owner-only controls and sensitive actions.</p>
  <div class="cards">
    <div class="card">
      <h3>Danger Zone</h3>
      <p>Owner actions like full reset or emergency shutdown.</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn danger" data-action="emergency-stop">Emergency Stop</button>
        <button class="btn warn" data-action="hot-reload">Hot Reload</button>
          <button class="btn info" data-action="consume-actions">Apply Pending Actions</button>
          <button class="btn" data-action="rebuild-caches">Rebuild Caches</button>
          <button class="btn" data-action="force-reload">Force Reload All</button>
          <button class="btn" data-action="clear-actions">Clear Action Queue</button>
      </div>
    </div>
    <div class="card">
      <h3>Cog Controls</h3>
      <p>Load/unload/reload a cog by name (use the simple name, e.g. <code>gameplay</code>).</p>
      <input id="cog-name" placeholder="cog name" />
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn primary" data-action="load-cog">Load</button>
        <button class="btn warn" data-action="unload-cog">Unload</button>
        <button class="btn info" data-action="reload-cog">Reload</button>
      </div>
    </div>
    <div class="card">
      <h3>User Data</h3>
      <p>Browse and edit cached user profiles used by the dashboard and other features.</p>
      <div style="display:flex;gap:8px">
        <a class="btn primary" href="/owner/users">Manage Users</a>
      </div>
    </div>
    <div class="card" id="owner-stats-card">
      <h3>Bot Stats</h3>
      <p>Live telemetry from the running bot.</p>
      <div style="display:flex;flex-direction:column;gap:6px">
        <div>Servers: <strong id="stat-servers">—</strong></div>
        <div>Extensions loaded: <strong id="stat-ext">—</strong></div>
        <div>Uptime: <strong id="stat-uptime">—</strong></div>
        <div>PID: <strong id="stat-pid">—</strong></div>
        <div>Last updated: <small id="stat-ts">—</small></div>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', ()=>{
      const api = async (path, opts={})=>{ const r = await fetch(path, opts); if(!r.ok) throw new Error('Request failed'); return r.json(); };
      document.querySelector('[data-action="hot-reload"]').addEventListener('click', async ()=>{ try{ await api('/cogs/hot_reload',{method:'POST'}); alert('Hot reload requested'); }catch(e){ alert('Failed: '+e.message)} });
      // apply pending actions by recording a 'hot_reload' or by instructing bot via owner command; here we just notify
      document.querySelector('[data-action="consume-actions"]').addEventListener('click', async ()=>{
        // try RPC endpoint on the bot for immediate apply, fallback to /actions/apply_now
        const rpcHost = 'http://127.0.0.1:' + (window.__CHRONIX_RPC_PORT || '9091') + '/rpc/consume';
        let triedRpc = false;
        try{
          triedRpc = true;
          const headers = {};
          if(window.__CHRONIX_API_KEY) headers['X-API-Key'] = window.__CHRONIX_API_KEY;
          const r = await fetch(rpcHost, {method:'POST', headers});
          if(r.ok){ alert('Apply request sent to bot RPC'); return; }
        }catch(e){ /* ignore and fallback */ }
        // fallback: write action via dashboard server
        try{
          const r2 = await fetch('/actions/apply_now', {method:'POST'});
          if(r2.ok) alert('Apply request queued'); else alert('Failed to queue');
        }catch(e){ alert('Failed: '+e.message); }
      });
      document.querySelector('[data-action="clear-actions"]').addEventListener('click', async ()=>{
        if(!confirm('Clear the dashboard action queue? This cannot be undone.')) return;
        try{ const r = await fetch('/actions/clear', {method:'POST'}); if(r.ok) alert('Cleared'); else alert('Failed'); }catch(e){ alert('Failed: '+e.message); }
      });
      document.querySelector('[data-action="load-cog"]').addEventListener('click', async ()=>{ const name=document.getElementById('cog-name').value; if(!name) return alert('Enter cog name'); try{ await api('/cogs/'+encodeURIComponent(name)+'/enable',{method:'POST'}); alert('Requested enable'); }catch(e){ alert('Failed: '+e.message); }});
      document.querySelector('[data-action="unload-cog"]').addEventListener('click', async ()=>{ const name=document.getElementById('cog-name').value; if(!name) return alert('Enter cog name'); try{ await api('/cogs/'+encodeURIComponent(name)+'/disable',{method:'POST'}); alert('Requested disable'); }catch(e){ alert('Failed: '+e.message); }});
      document.querySelector('[data-action="reload-cog"]').addEventListener('click', async ()=>{ const name=document.getElementById('cog-name').value; if(!name) return alert('Enter cog name'); try{ await api('/cogs/'+encodeURIComponent(name)+'/reload',{method:'POST'}); alert('Requested reload'); }catch(e){ alert('Failed: '+e.message); }});
      document.querySelector('[data-action="rebuild-caches"]').addEventListener('click', async ()=>{
        try{
          const r = await fetch('/owner/rebuild_caches', {method:'POST'});
          if(r.ok) alert('Rebuild caches requested'); else alert('Failed');
        }catch(e){ alert('Failed: '+e.message); }
      });
      document.querySelector('[data-action="force-reload"]').addEventListener('click', async ()=>{
        if(!confirm('Force reload all extensions? This may be disruptive.')) return;
        try{
          const r = await fetch('/owner/force_reload_all', {method:'POST'});
          if(r.ok) alert('Force reload requested'); else alert('Failed');
        }catch(e){ alert('Failed: '+e.message); }
      });
      // fetch owner stats periodically
      async function refreshOwnerStats(){
        try{
          const r = await fetch('/metrics/stats'); if(!r.ok) return;
          const j = await r.json(); const s = j.stats || {};
          document.getElementById('stat-servers').textContent = s.server_count != null ? String(s.server_count) : '—';
          document.getElementById('stat-ext').textContent = s.extensions != null ? String(s.extensions) : '—';
          document.getElementById('stat-pid').textContent = s.pid != null ? String(s.pid) : '—';
          document.getElementById('stat-ts').textContent = s.ts ? new Date(s.ts*1000).toLocaleString() : '—';
          if(s.uptime != null){ const up = Number(s.uptime); const h=Math.floor(up/3600); const m=Math.floor((up%3600)/60); const sec=up%60; document.getElementById('stat-uptime').textContent = `${h}h ${m}m ${sec}s`; }
        }catch(e){ /* ignore */ }
        setTimeout(refreshOwnerStats, 6000);
      }
      refreshOwnerStats();
    });
  </script>
{% endblock %}
