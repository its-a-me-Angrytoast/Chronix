{% extends "base.html" %}
{% block content %}
  <h1>{{ title }}</h1>
  <p class="lead">Manage the <strong>{{ cog }}</strong> cog. Change its settings below.</p>
  <div class="cards">
    <div class="card">
      <h3>Status</h3>
      <p>Current status: <strong class="cog-status">{{ 'Enabled' if enabled else 'Disabled' }}</strong></p>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn primary" id="enable-btn">Enable</button>
        <button class="btn warn" id="disable-btn">Disable</button>
        <button class="btn info" id="reload-btn">Reload</button>
      </div>
    </div>

    <div class="card">
      <h3>Configuration</h3>
        <form id="cfg-form">
          <label>Description</label>
          <textarea name="description" rows="4">{{ config.get('description','') }}</textarea>
          <label>Display title</label>
          <input name="title" value="{{ config.get('title','') }}" />
          <label style="margin-top:8px">Behavior</label>
          <div style="display:flex;gap:8px;align-items:center">
            <label style="font-size:13px;color:var(--muted)">Reload on error</label>
            <input type="checkbox" name="reload_on_error" {{ 'checked' if config.get('reload_on_error') else '' }} />
          </div>

          {% if schema %}
            <hr />
            <h4>Settings</h4>
            <div id="schema-fields">
              {% for field in schema.get('fields', []) %}
                <div class="schema-row">
                  <label>{{ field.get('label') or field.get('name') }}</label>
                  {% if field.get('type') == 'boolean' %}
                    <input type="checkbox" data-schema-field name="{{ field.get('name') }}" {{ 'checked' if config.get(field.get('name')) else '' }} />
                  {% elif field.get('type') == 'select' %}
                    <select data-schema-field name="{{ field.get('name') }}">
                      {% for opt in field.get('options', []) %}
                        <option value="{{ opt }}" {% if config.get(field.get('name')) == opt %}selected{% endif %}>{{ opt }}</option>
                      {% endfor %}
                    </select>
                  {% elif field.get('type') == 'number' %}
                    <input data-schema-field type="number" name="{{ field.get('name') }}" value="{{ config.get(field.get('name'), field.get('default') or '') }}" />
                  {% elif field.get('type') == 'textarea' %}
                    <textarea data-schema-field name="{{ field.get('name') }}">{{ config.get(field.get('name'), field.get('default') or '') }}</textarea>
                  {% else %}
                    <input data-schema-field type="text" name="{{ field.get('name') }}" value="{{ config.get(field.get('name'), field.get('default') or '') }}" />
                  {% endif %}
                  {% if field.get('help') %}<div class="note">{{ field.get('help') }}</div>{% endif %}
                </div>
              {% endfor %}
            </div>
          {% endif %}

          <hr />
          <h4>Advanced options</h4>
          <div id="advanced-options">
            {% for k, v in config.items() %}
              {% if schema %}
                {% set skip = ['description','title','reload_on_error'] + [f.get('name') for f in schema.get('fields',[])] %}
              {% else %}
                {% set skip = ['description','title','reload_on_error'] %}
              {% endif %}
              {% if k not in skip %}
                <div class="adv-row" data-key="{{ k }}">
                  <input class="adv-key" value="{{ k }}" readonly />
                  <input class="adv-val" value="{{ v }}" />
                  <button type="button" class="btn danger adv-remove">Remove</button>
                </div>
              {% endif %}
            {% endfor %}
          </div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <input id="new-key" placeholder="key" />
            <input id="new-val" placeholder="value" />
            <button type="button" id="add-adv" class="btn">Add Option</button>
          </div>
          <button class="btn primary" type="submit" style="margin-top:12px">Save</button>
        </form>
    </div>

      <div class="card">
        <h3>Cog Actions</h3>
        <p>Send an ad-hoc action to the cog (the cog can optionally implement <code>handle_dashboard_action(name, payload)</code>).</p>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="action-name" placeholder="action name (e.g. clear_queue)" />
          <input id="action-payload" placeholder='JSON payload (optional)' />
          <button class="btn" id="send-action">Send</button>
        </div>
      </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', ()=>{
      const cog = '{{ cog }}';
      const base = '/cogs/' + encodeURIComponent(cog);
      document.getElementById('enable-btn').addEventListener('click', async ()=>{
        await fetch(base + '/enable', {method:'POST'});
        location.reload();
      });
      document.getElementById('disable-btn').addEventListener('click', async ()=>{
        await fetch(base + '/disable', {method:'POST'});
        location.reload();
      });
      document.getElementById('reload-btn').addEventListener('click', async ()=>{
        await fetch(base + '/reload', {method:'POST'});
        alert('Reload requested');
      });

      document.getElementById('cfg-form').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const form = e.currentTarget;
        const data = {description: form.description.value, title: form.title.value, reload_on_error: !!form.reload_on_error.checked};
        // collect schema fields if present
        document.querySelectorAll('[data-schema-field]').forEach(el=>{
          const name = el.getAttribute('name');
          if(!name) return;
          if(el.type === 'checkbox') data[name] = !!el.checked;
          else if(el.tagName.toLowerCase() === 'select') data[name] = el.value;
          else if(el.type === 'number') data[name] = (el.value===''?null: Number(el.value));
          else data[name] = el.value;
        });
        // collect advanced options
        const adv = {};
        document.querySelectorAll('#advanced-options .adv-row').forEach(r=>{
          const k = r.querySelector('.adv-key').value;
          const v = r.querySelector('.adv-val').value;
          if(v === 'true' || v === 'false') adv[k] = (v === 'true');
          else if(!isNaN(Number(v))) adv[k] = Number(v);
          else adv[k] = v;
        });
        Object.assign(data, adv);
        const res = await fetch('/cogs/config/' + encodeURIComponent(cog), {method:'PUT', headers:{'content-type':'application/json'}, body: JSON.stringify(data)});
        if(res.ok) alert('Saved'); else alert('Save failed');
      });

      document.getElementById('send-action').addEventListener('click', async ()=>{
        const name = document.getElementById('action-name').value;
        const payload = document.getElementById('action-payload').value || '';
        if(!name) return alert('Enter action name');
        let parsed = {};
        if(payload){ try{ parsed = JSON.parse(payload); }catch(e){ return alert('Invalid JSON payload'); } }
        try{
          const res = await fetch('/cogs/'+encodeURIComponent(cog)+'/action/'+encodeURIComponent(name), {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(parsed)});
          if(res.ok) alert('Action queued'); else alert('Failed');
        }catch(e){ alert('Failed: '+e.message); }
      });

      // add option UI handlers
      document.getElementById('add-adv').addEventListener('click', ()=>{
        const k = document.getElementById('new-key');
        const v = document.getElementById('new-val');
        if(!k.value) return alert('Enter a key');
        const container = document.getElementById('advanced-options');
        const row = document.createElement('div'); row.className='adv-row'; row.dataset.key = k.value;
        const kinput = document.createElement('input'); kinput.className='adv-key'; kinput.value = k.value; kinput.readOnly = true;
        const vinput = document.createElement('input'); vinput.className='adv-val'; vinput.value = v.value;
        const rem = document.createElement('button'); rem.type='button'; rem.className='btn danger adv-remove'; rem.textContent='Remove';
        rem.addEventListener('click', ()=>row.remove());
        row.appendChild(kinput); row.appendChild(vinput); row.appendChild(rem);
        container.appendChild(row);
        k.value=''; v.value='';
      });
      document.querySelectorAll('.adv-remove').forEach(b=>b.addEventListener('click', (e)=>{ e.currentTarget.closest('.adv-row').remove(); }));
    });
  </script>

{% endblock %}
